# U-boot with patches to make the PinePhone boot faster and have control over the ddr clock speed
pkgname=u-boot-pinephone
pkgver=2021.07
pkgrel=1
pkgdesc="U-Boot bootloader for the PINE64 PinePhone"
url="https://source.denx.de/u-boot"
arch="aarch64"
license="GPL-2.0-or-later OFL-1.1 BSD-2-Clause BSD-3-Clause eCos-2.0 IBM-pibs
	ISC LGPL-2.0-only LGPL-2.1-only X11"
depends="linux-postmarketos-allwinner>=5.12"
makedepends="$depends_dev bc dtc python3-dev py3-setuptools swig bison flex openssl-dev arm-trusted-firmware crust"
options="!check"
source="https://source.denx.de/u-boot/u-boot/-/archive/v$pkgver/u-boot-v$pkgver.tar.gz
	update-u-boot
	0001-mmc-sunxi-Avoid-ifdefs-in-delay-and-width-setup.patch
	0002-mmc-sunxi-Fix-warnings-with-CONFIG_PHYS_64BIT.patch
	0003-mmc-sunxi-Fix-MMC-clock-parent-selection.patch
	0004-mmc-sunxi-Cleanup-new-timing-mode-selection.patch
	0005-mmc-sunxi-Enable-new-timing-mode-on-all-new-SoCs.patch
	0006-mmc-sunxi-Cleanup-and-fix-self-calibration-code.patch
	0007-mmc-sunxi-Increase-MMIO-FIFO-read-performance.patch
	0008-mmc-sunxi-Use-mmc_of_parse.patch
	0009-sunxi-DT-H5-update-device-tree-files.patch
	0010-sunxi-DT-H6-update-device-tree-files.patch
	0011-phy-sun50i-usb3-Add-a-driver-for-the-H6-USB3-PHY.patch
	0012-usb-xhci-pci-Move-reset-logic-out-of-XHCI-core.patch
	0013-usb-xhci-dwc3-Add-support-for-clocks-resets.patch
	0014-configs-Enable-USB3-on-Allwinner-H6-boards.patch
	0015-tools-Refactor-mkimage-linking-with-OpenSSL.patch
	0016-tools-mkimage-Add-Allwinner-TOC0-support.patch
	0017-sunxi-Support-both-SPL-image-types.patch
	0018-sunxi-Support-building-a-SPL-as-a-TOC0-image.patch
	0019-sunxi-H616-Enable-full-4GB-of-DRAM.patch
	0020-sunxi-DT-H6-Add-USB3-to-Pine-H64-DTS.patch
	0021-sunxi-Select-environment-MMC-based-on-boot-device.patch
	0022-sunxi-Load-sun8i-secure-monitor-to-SRAM-A2.patch
	0023-pinephone-Add-volume_key-environment-variable.patch
	0024-Enable-led-on-boot-to-notify-user-of-boot-status.patch
	0025-disable-bootdelay.patch
	0026-Reduce-DRAM-speed-to-528-for-better-compatibility-wi.patch
	0027-mmc-sunxi-Add-support-for-DMA-transfers.patch
	0028-mmc-sunxi-DDR-DMA-support-for-SPL.patch
	0029-spl-ARM-Enable-CPU-caches.patch
	0030-common-expose-DRAM-clock-speed.patch
	"
builddir="$srcdir/u-boot-v$pkgver"
install="$pkgname.post-upgrade"
frequencies='528 552 624'

build() {
	touch include/config.h
	LC_ALL=C date +'#define U_BOOT_DATE "%b %d %C%y"' > include/timestamp_autogenerated.h
	LC_ALL=C date +'#define U_BOOT_TIME "%T"' >> include/timestamp_autogenerated.h

	export BL31="/usr/share/arm-trusted-firmware/sun50i_a64/bl31.bin"
	export SCP="/usr/share/crust/pinephone/scp.bin"
	export BUILD_DIR="$builddir"/build

	for freq in $frequencies; do
		mkdir -p "$BUILD_DIR-$freq"
		sed -rie "s/^(CONFIG_DRAM_CLK=).*$/CONFIG_DRAM_CLK=$freq/" configs/pinephone_defconfig
		cat configs/pinephone_defconfig | grep CONFIG_DRAM_CLK
		make O="$BUILD_DIR-$freq" HOSTCC=gcc ARCH=arm pinephone_defconfig
		make O="$BUILD_DIR-$freq" HOSTCC=gcc ARCH=arm all
		sha512sum -b "$BUILD_DIR-$freq/u-boot-sunxi-with-spl.bin" > "$BUILD_DIR-$freq/u-boot-sunxi-with-spl.bin.sha512"
	done
}

package() {
	for freq in $frequencies; do
		install -D -m644 "build-$freq/u-boot-sunxi-with-spl.bin" \
			"$pkgdir/usr/share/u-boot/pine64-pinephone/u-boot-sunxi-with-spl-$freq.bin"
		install -D -m644 "build-$freq/u-boot-sunxi-with-spl.bin.sha512" \
			"$pkgdir/usr/share/u-boot/pine64-pinephone/u-boot-sunxi-with-spl-$freq.bin.sha512"
	done
	install -D -m 755 "$srcdir"/update-u-boot "$pkgdir"/usr/sbin/update-u-boot
}

sha512sums="
bbfc92bda2d9229787f507d2e3c120a8536788b198b910fb018f851e6990f73de4a57bc9686664f777c1665573c2f9015e1e7bbfcec5773dc957dbb71f2aa56b  u-boot-v2021.07.tar.gz
d6e1ca6100fdc0ecd9559d556bb8f6699ff807a180d097808417cdacc07fc22b58f8bf33f1f104fcbb28201bd873e469f251176605bec123870ff49bde50024c  update-u-boot
05ae2fa9ce48567f91589b6bbf69f0849b37ef11b2cc98c400e3d08fd5d52d02ad4bc30111cbf2e9bfe75a2b2b68606193110019bfc8e2e451c8ab0a2d6153ca  0001-mmc-sunxi-Avoid-ifdefs-in-delay-and-width-setup.patch
57ff8c7bbd697e183cce079e6d4fb272909aa1d00aa4d6a0fabb2cfd395c1e051be11846aad8aafdf92b4fe98760742e0a1a3d7ecd763e8b8a4e0b656fe53d1e  0002-mmc-sunxi-Fix-warnings-with-CONFIG_PHYS_64BIT.patch
bb10dabb6b66d38ca406fd8be656be9fc5582e5224e54d2fd4cd33dd7ee20a1c976fa1b5807a3c740534ddc22782330fbd5e4b436917416acc05a63dd3e9d181  0003-mmc-sunxi-Fix-MMC-clock-parent-selection.patch
6fe63a013a3716c962647f166c085cbb3edd0ed18511a97e51f5c32aff752c3a3581f6b68ff7bf482e91ebf29cb098b3f6bd5f11f491aff65f999120b3520267  0004-mmc-sunxi-Cleanup-new-timing-mode-selection.patch
1eb21c9f5af6580937d7e107f742a226d3b95d49adf4ea77b7812c76d9102506adbc219a49476d0e8f84a536bc43fb53a288eec0708f41454327f85a7e7ab59d  0005-mmc-sunxi-Enable-new-timing-mode-on-all-new-SoCs.patch
e794d989d31672d7ad05730dd469ad91e3ed1c1cb40bff25f2df6bdb364417ad288b79700ca7223d0f82ce750cfa158a72d19191d7b5e8fa549efc59b0cf902f  0006-mmc-sunxi-Cleanup-and-fix-self-calibration-code.patch
1b5c17632f4a680727c2548940bcccca6615f6847fed121ddef03dcadc5b9eceb1de8e03dcc71abc0cc496a73068c40cfb50ad98aa051b3e9af090e959e23cca  0007-mmc-sunxi-Increase-MMIO-FIFO-read-performance.patch
752d8831c348c019c67593a6d8c23ce238ab96957fda0f56f2dc2831afc8a5367bff33627c8002a9ead55e9a878440ffee5da2d9a73d2c0733895cf2f4f076a8  0008-mmc-sunxi-Use-mmc_of_parse.patch
4076ee3fcf746e7b3ca1519646af5a9cc5befb8dedbd32b6737cbe4e422e0a0e7100da265f2feac2d77fa1fd5d510c5251c9d3672b006cd290c9f906d8af673c  0009-sunxi-DT-H5-update-device-tree-files.patch
aa951994ccd7cfdfa6e5f34cf87229d6cf5d87c4c7eaeab38904f3fa704c17dd8cfe9c67b9f1e123a80dbed9e7724314bb9914630a7df4d3bff55d11a10b3241  0010-sunxi-DT-H6-update-device-tree-files.patch
c59a36a6dfc0313076baaa3ada2ffd17710d816b0590aa4970354ccf60e503df1b23c7701c2abf6c9625df7b76e0b0ff81079bd6b7c8c7c68cabf56b26c2b25f  0011-phy-sun50i-usb3-Add-a-driver-for-the-H6-USB3-PHY.patch
1f1f5394ef2699d011ba89fe8161f6b792b3862a26c112d9085404db4ccbe090376e9f7487268aeb492bc7bc72d6217e3e29612b30d8e687af3990d781786fe8  0012-usb-xhci-pci-Move-reset-logic-out-of-XHCI-core.patch
d93307d1d0d583cd041b54bd17e0b60ff6cd886435f528898495bdfaa9e19ab578ee7d8edcd6523757bfe6a2f70305e4633a082a994cdc5850deba3ff4720d89  0013-usb-xhci-dwc3-Add-support-for-clocks-resets.patch
c426c2145654d5ad34980ee2255155f63d7e6aa374a21f7d4d3a9ff7cc96ceec6a6267beef9ca2024d1f8c82285d6e0c76e5f9dc0b4af12c1316fd7a0e483936  0014-configs-Enable-USB3-on-Allwinner-H6-boards.patch
c32c8a8760239350408d3c78dcad0226cf8576ca7b75cbe52cb4eee7d0a9f8d824b022c5767d703aae89a811c8ac6b953620cb5ec69166e3d8b31bad8a501c25  0015-tools-Refactor-mkimage-linking-with-OpenSSL.patch
607a86a2f76fc8338da083ccb068bc140ff8513d2a48c479a4f4c2e3307853485db708cbe381cd36498240d7752c83b6667d696251fd27ac96b41a2dec9f8911  0016-tools-mkimage-Add-Allwinner-TOC0-support.patch
9eaf3a854250df8863eec109912f5351e3a3a165677770c016b0c3b60e66e9dd8370cf6e6bd4b3f0ba00e777c1a3a1e05e4fc69a1e709e6e784f71b306ba6e13  0017-sunxi-Support-both-SPL-image-types.patch
07c1cad4b3e6ff2a220c2e1f7b613bb0265e58b203016e523d3c1055e465c2a4b697b1761cf8823b80fa8ad056beb7a4169aa551c76a2814675f841f15adab28  0018-sunxi-Support-building-a-SPL-as-a-TOC0-image.patch
19f7f99e0649780226915f97b22c30fb1963aa5267d7f07bef727cbae4c6a4750ba31a4f807601d53f53fd605c16f1c462b4b255783220fe91faa297db6de3c1  0019-sunxi-H616-Enable-full-4GB-of-DRAM.patch
44ce977b41a07b64f61328e17a5b7bb19b8ff2cfc0664946a869b22b2e03ecbfab8a64bec41adafcce7c6351d570882246020fcdaa81b43c1af512d41a239d62  0020-sunxi-DT-H6-Add-USB3-to-Pine-H64-DTS.patch
5d77c5c253c31b47c41f159d3c0f0954ce84bd8cde39c39a5894e40ff5e89439ea6e133c66e254a39aab621cb6f3b252ab36ea91a3beff122cdb2e023b9599f1  0021-sunxi-Select-environment-MMC-based-on-boot-device.patch
299be54d9cc6bc5190ae28d020db1d0e91cdc2ff15c28a5779972c5b77cc80dd9cf8209f1a380971118356963efea0b5afcbd49753b8f192d8667f65eaa87825  0022-sunxi-Load-sun8i-secure-monitor-to-SRAM-A2.patch
95a1f9277b92b4dfeac8dd2ebd00425ef266d5dd1f3874d3d283b88421a84698df09513f4b6d317de983b3ce4351deba660c5d6c0ef9fa4abcd3e0030dc53ada  0023-pinephone-Add-volume_key-environment-variable.patch
4e2f803f287fde9874a3e49f7a1ba07bce8760270bffa5d204915eaf8fd26be2ca7575bb3e4fc997e05321e93ecea14eba7f733ad78f78075e42b63239c76f67  0024-Enable-led-on-boot-to-notify-user-of-boot-status.patch
c9b0e640fe021c33be3e60defbef6a784cd482566ca0cfc54d05a63fe9bd4bc4c9e87eed4262eb531ac47e8af69660baf29906130542704d23a51f4a680690cc  0025-disable-bootdelay.patch
f982f87bb34544d3dca38bfda3157a355d48a058315a80fe525acefa14a03698857e14ed40c40d36b78db9158d2e158af88a000c239b0470a6ca70c5ad74847b  0026-Reduce-DRAM-speed-to-528-for-better-compatibility-wi.patch
ae2d0baf7c2048e142230741368db1d0520b1764d62e798098d2548b0ba9622f098f64edc0988db10963543ca0169ae6f3db609f436e1fd090d785274cf30283  0027-mmc-sunxi-Add-support-for-DMA-transfers.patch
eff2901ac5e14949f326a9d8b553f6f32d7e89502929090595b360d1b76d0d3335c94d0c4960b25603f9786524baf2386251bd4a18582ed1012a6db3e5e84618  0028-mmc-sunxi-DDR-DMA-support-for-SPL.patch
f2ee73c774758bd13872d370bc7990474adc453531dacf15664609ca0fdc2a4844d4769376c370b7d18896ac734a7080ee709066659647a4cf0368928bf5e198  0029-spl-ARM-Enable-CPU-caches.patch
86d9587cb2b0ca99fb4090bd0daacd47c0043858654f6f7114c8d0ed6c660eb2b8bc0b37de6723e738df9b1137d62482f00764c284f4aa0a6054db9efe754db9  0030-common-expose-DRAM-clock-speed.patch
"
